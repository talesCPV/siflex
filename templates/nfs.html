
<template>
    <style>

        button{
            width: 98%;
        }

    </style>

    <div class="form-base">
        <h1>NFs Serviço</h1>

        <div class="tab-bar">
            <div class="tab-item" id="tab-emitente" onclick="pictab(this)">Emitente    </div>
            <div class="tab-item" id="tab-pedido"   onclick="pictab(this)">Serviço     </div>
            <div class="tab-item" id="tab-cliente"  onclick="pictab(this)">Cliente     </div>            
            <div class="tab-item" id="tab-itens"    onclick="pictab(this)">Itens       </div>
            <div class="tab-item" id="tab-fatura"   onclick="pictab(this)">Faturamento </div>
            <div class="tab-item" id="tab-export"   onclick="pictab(this)">Arquivos</div>
        </div>
        
        <div class="tab-screen">        
            <div id="emitente" class="tab">
                <div class="inline">
                    <label> Razão Social *</label>
                    <input type="text" id="xNome" maxlength="60" />
                </div>
                <div class="inline">
                    <label> CNPJ </label>
                    <input type="text" id="CNPJ" maxlength="18" onkeyup="valCNPJ(this)"/>
                </div>
                <div class="inline">
                    <label> Endereço </label>
                    <input type="text" id="xLgr" maxlength="60" />
                    <label> Número: </label>
                    <input type="text" id="nro" maxlength="5" style="max-width: 100px;" />
                </div>
                <div class="inline">
                    <label> Bairro </label>
                    <input type="text" id="bairro" maxlength="60" />
                    <label> Complemento </label>
                    <input type="text" id="cpl" maxlength="60" style="max-width: 200px;" />
                </div>
                <div class="inline">
                    <label> Municipio</label>
                    <input type="text" id="xMun" maxlength="60" />
                    <label> Sigla da UF </label>
                    <input type="text" id="UF" maxlength="2" style="max-width: 50px;" />
                </div>
                <div class="inline">
                    <label> CEP </label>
                    <input type="text" id="CEP" maxlength="8" onkeyup="valCEP(this)"/>
                    <label> Email </label>
                    <input type="text" id="email" maxlength="50"/>
                </div>
                <button id="btnSaveEmit">Salvar</button>
            </div>
            <div id="pedido" class="tab">
                <fieldset>
                    <legend>Busca Por:</legend>
                    <div class="inline">
                        <select id="cmbBusca">
                            <option value="true"   signal="="  val="true">Todos</option>
                            <option value="EMP.fantasia" signal="LIKE">Cliente</option>
                            <option value="EMP.id" signal="=">Código do Cliente</option>
                            <option value="SERV.num_carro" signal="LIKE">Num. do Carro</option>
                            <option value="SERV.nf" signal="IN">NF</option>
                            <option value="SERV.pedido" signal="IN">Pedido</option>
                            <option value="SERV.id" signal="IN">Cod. Serv. Executado</option>
                        </select>
                        <input type="text" id="edtBusca"placeholder="Digite sua Busca" onkeypress="return getEnter(event, 'btnBusca')">
                        <button id="btnBusca">Busca</button>
                    </div>
                    <div class="inline center-itens">
                        <div class="ckBOX">
                            <label for="ckbData">Por data</label>
                            <input type="checkbox" id="ckbData" checked>
                        </div>
                        <input type="date" id="edtIni" onkeypress="return getEnter(event, 'btnBusca')">
                        <input type="date" id="edtFin" onkeypress="return getEnter(event, 'btnBusca')">
                    </div>
        
                </fieldset>

                <table id="tblServExec"></table>


            </div>
            <div id="cliente" class="tab">
                <div class="inline">
                    <label> Razão Social *</label>
                    <input type="text" id="xNome" maxlength="60" />
                </div>
                <div class="inline">
                    <label> CNPJ </label>
                    <input type="text" id="CNPJ" maxlength="18" onkeyup="valCNPJ(this)"/>
                </div>
                <div class="inline">
                    <label> Endereço </label>
                    <input type="text" id="xLgr" maxlength="60" />
                    <label> Número: </label>
                    <input type="text" id="nro" maxlength="5" style="max-width: 100px;" />
                </div>
                <div class="inline">
                    <label> Bairro </label>
                    <input type="text" id="bairro" maxlength="60" />
                    <label> Complemento </label>
                    <input type="text" id="cpl" maxlength="60" style="max-width: 200px;" />
                </div>
                <div class="inline">
                    <label> Municipio</label>
                    <input type="text" id="xMun" maxlength="60" />
                    <label> Sigla da UF </label>
                    <input type="text" id="UF" maxlength="2" style="max-width: 50px;" />
                </div>
                <div class="inline">
                    <label> CEP </label>
                    <input type="text" id="CEP" maxlength="8" onkeyup="valCEP(this)"/>
                    <label> Email </label>
                    <input type="text" id="email" maxlength="50"/>
                </div>
                <button id="btnSaveCli">Salvar</button>
            </div>
            <div id="itens" class="tab">
                <fieldset>
                    <legend>Descriminação dos Serviços</legend>
                    <textarea id="txtServicos" cols="30" rows="80"></textarea>
                </fieldset>
            </div>
            <div id="fatura" class="tab">
                <div class="inline">
                    <label for="edtNfsNum">Num NFs</label>
                    <input type="text" id="edtNfsNum" onkeyup="valInt(this)">
                    <label for="edtRps">RPS Defasagem</label>
                    <input type="text" id="edtRps" onkeyup="valInt(this)">
                </div>
                <div class="inline">
                    <label for="edtValor">Valor</label>
                    <input type="text" id="edtValor" value="0.00" onkeyup="valFloat(this)">
                    <label for="edtDias">Dias entre Parcelas</label>
                    <input type="text" id="edtDias" value="28">
                    <label for="edtAliq">Alíquota</label>
                    <input type="text" id="edtAliq" onkeyup="valFloat(this)">
                </div>
                <div class="inline">
                    <label for="cmbLocal">Local Execução</label>
                    <select id="cmbLocal">
                        <option value="TOM" selected>No Cliente</option>
                        <option value="PRE">Na Empresa</option>
                    </select>
                    <label for="cmbRetFont">ISS Retido na Fonte</label>
                    <select id="cmbRetFont">
                        <option value="SIM">Sim</option>
                        <option value="NAO" selected>Não</option>
                    </select>
                </div>
                <fieldset>
                    <legend>Dedução / Outras Informações</legend>
                    <textarea id="txtInfo" cols="30" rows="15">Serviço aprovado conforme Pedido:</textarea>
                </fieldset>
                <button id="brnGeraNFs">Gerar NFs</button>
            </div>
            <div id="export" class="tab">
                <fieldset>
                    <legend>TXT</legend>
                    <select id="txtFiles" size="20"></select>
                </fieldset>
                <fieldset>
                    <legend>XML</legend>
                    <select id="xmlFiles" size="20"></select>
                </fieldset>                
            </div>                
        </div>

    </div>



</template>
<script>

    importData()
    listNF('NFs/txt')
    listNF('NFs/xml','xml')

    document.querySelector('#tab-emitente').click()
    document.querySelector('#edtIni').value = today.iniMonth()
    document.querySelector('#edtFin').value = today.finMonth()

    function getTXT(){
        let out = ''
            for(let key in main_data.NFs){
                if(['10','20','90'].includes(key)){
                    for(let item in main_data.NFs[key]){
                        out += main_data.NFs[key][item]+'|'
                    }
                    out += '\n'
                }
            }
            return out   
    }

    function saveFiscal(){

        main_data.NFs.CONF.DefRPS = document.querySelector('#edtRps').value.trim()

        let now = new Date
        main_data.NFs['20'].TipoNf = 'P'
        main_data.NFs['20'].NumNf = document.querySelector('#edtNfsNum').value.trim().padStart(9,'0')
        main_data.NFs['20'].SerNf = 'NFE'
        main_data.NFs['20'].DtEmiNf = now.getFormatBR()
        main_data.NFs['20'].DtHrGerNf = now.getFullDate()
        main_data.NFs['20'].NumRps = (parseInt(document.querySelector('#edtNfsNum').value)-parseInt(document.querySelector('#edtRps').value)).toString().padStart(9,'0')
        main_data.NFs['20'].SerRps = '001'
        main_data.NFs['20'].DtEmiRps = now.getFormatBR()
        main_data.NFs['20'].TipoCpfCnpjPre = '2' // 1-CPF 2-CNPJ
        main_data.NFs['20'].AlqIssSN = getNumComa(document.querySelector('#edtAliq').value)
        main_data.NFs['20'].SitNf = '1' // 1-Normal. 2-Cancelada. 3-Extraviada. 4-devolução. 5-não tributada.

        const local = document.querySelector('#cmbLocal').value
        const cliente = document.querySelector('#cliente')
        const emitente = document.querySelector('#emitente')
        main_data.NFs['20'].LogLocPre = local=='TOM' ? cliente.querySelector('#xLgr').value : emitente.querySelector('#xLgr').value
        main_data.NFs['20'].NumLocPre = local=='TOM' ? cliente.querySelector('#nro').value : emitente.querySelector('#nro').value
        main_data.NFs['20'].CompLocPre = local=='TOM' ? cliente.querySelector('#cpl').value : emitente.querySelector('#nro').value
        main_data.NFs['20'].BairroLocPre = local=='TOM' ? cliente.querySelector('#bairro').value : emitente.querySelector('#bairro').value
        main_data.NFs['20'].MunLocPre = local=='TOM' ? cliente.querySelector('#xMun').value : emitente.querySelector('#xMun').value
        main_data.NFs['20'].SiglaUFLocPre = local=='TOM' ? cliente.querySelector('#UF').value : emitente.querySelector('#UF').value
        main_data.NFs['20'].CepLocPre = local=='TOM' ? getNum(cliente.querySelector('#CEP').value) : getNum(emitente.querySelector('#CEP').value)

        main_data.NFs['20'].CodSrv = '14.01'
        main_data.NFs['20'].DiscrSrv = document.querySelector('#txtServicos').value.replaceAll('\n', '\\\\')
        main_data.NFs['20'].VlNFS = getNumComa(document.querySelector('#edtValor').value)
        main_data.NFs['20'].VlDed = '0,00'
        main_data.NFs['20'].VlBasCalc = getNumComa(document.querySelector('#edtValor').value)
        main_data.NFs['20'].AlqIss = getNumComa(document.querySelector('#edtAliq').value)

        const retido = document.querySelector('#cmbRetFont').value
        const iss = getNumComa(parseFloat(document.querySelector('#edtValor').value)*(parseFloat(document.querySelector('#edtAliq').value)/100))

        main_data.NFs['20'].VlIss = retido=='SIM' ? '0,00' : iss
        main_data.NFs['20'].VlIssRet = retido=='SIM' ? iss : '0,00' 

        main_data.NFs['90'].QtdRegNormal = '00001'
        main_data.NFs['90'].ValorNFS = getNumComa(document.querySelector('#edtValor').value)
        main_data.NFs['90'].ValorISS = retido=='SIM' ? '0,00' : iss
        main_data.NFs['90'].ValorDed = '0,00'
        main_data.NFs['90'].ValorIssRet = retido=='SIM' ? iss : '0,00'
        main_data.NFs['90'].QtdReg30 = '0'
        main_data.NFs['90'].ValTrib = '0,00'

        const parc = document.querySelector('#edtDias').value.split('/')
        const total = parseFloat(document.querySelector('#edtValor').value)        
        let fatura = ''
        let pg = 0
        for(let i=0; i< parc.length; i++){
            now = new Date
            now.change(parseInt(parc[i]))
            fatura += `\\\\Pgto ${(i+1).toString().padStart(2,"0")}/${(parc.length).toString().padStart(2,"0")} Venc.${now.getFormatBR()} Valor R$${i != (parc.length-1) ? (total/parc.length).toFixed(2) : (total-pg).toFixed(2)}`
            pg += (total/parc.length)
        }
        fatura += '\\\\**Tributado pelo ANEXO III Simples Nacional Conforme LC 123/200'
        main_data.NFs['20'].DiscrDed = document.querySelector('#txtInfo').value.replaceAll('\n', '\\\\') + fatura


        NFeConf(main_data.NFs,'NFs.json')
    }

    function uploadNFs(txt, filename){
        const data = new URLSearchParams();        
            data.append("txt",txt);
            data.append("filename",filename);
            data.append("folder",'NFs/txt');
        const myRequest = new Request("backend/nfe_SAVE.php",{
            method : "POST",
            body : data
        });
        fetch(myRequest).then(()=>{
            const myRequest2 = new Request("backend/nfs_TXT2XML.php",{
                method : "POST",
                body : data
            });
            fetch(myRequest2).then(()=>{
                alert('NFs exportada com sucesso!')
                listNF('NFs/txt')
                listNF('NFs/xml','xml')
                document.querySelector('#tab-export').click()
            })          

        })
    }

    function importData(){
        NFeConf('','NFs.json').then((txt)=>{
            main_data.NFs = JSON.parse(txt)
            const emitente = document.querySelector('#emitente')
            emitente.querySelector('#xNome').value = main_data.NFs['20'].RazSocPre
            emitente.querySelector('#CNPJ').value = getCNPJ(main_data.NFs['20'].CpfCnpjPre)
            emitente.querySelector('#xLgr').value = main_data.NFs['20'].LogPre
            emitente.querySelector('#nro').value = main_data.NFs['20'].NumEndPre
            emitente.querySelector('#bairro').value = main_data.NFs['20'].BairroPre
            emitente.querySelector('#cpl').value = main_data.NFs['20'].ComplEndPre
            emitente.querySelector('#xMun').value = main_data.NFs['20'].MunPre
            emitente.querySelector('#UF').value = main_data.NFs['20'].SiglaUFPre
            emitente.querySelector('#CEP').value = getCEP(main_data.NFs['20'].CepPre)
            emitente.querySelector('#email').value = main_data.NFs['20'].EmailPre.toLowerCase()

            const fatura = document.querySelector('#fatura')
            fatura.querySelector('#edtNfsNum').value = parseInt(main_data.NFs['20'].NumNf)+1
            fatura.querySelector('#edtRps').value = main_data.NFs.CONF.DefRPS
            fatura.querySelector('#edtAliq').value = (main_data.NFs['20'].AlqIssSN)
            document.querySelector('#edtAliq').onkeyup()
        })
    }

    document.querySelector('#brnGeraNFs').addEventListener('click',()=>{

        saveFiscal()
        const txt = getTXT()
        const filename = 'NFs-'+main_data.NFs['20'].NumNf
        uploadNFs(txt, filename)

    })

    document.querySelector('#btnSaveEmit').addEventListener('click',()=>{
        const emitente = document.querySelector('#emitente')
        main_data.NFs['20'].RazSocPre = emitente.querySelector('#xNome').value.trim().toUpperCase()
        main_data.NFs['20'].TipoCpfCnpjPre = '2'
        main_data.NFs['20'].CpfCnpjPre = getNum(emitente.querySelector('#CNPJ').value)
        main_data.NFs['10'].CpfCnpj = getNum(emitente.querySelector('#CNPJ').value)
        main_data.NFs['20'].LogPre = emitente.querySelector('#xLgr').value.trim().toUpperCase()
        main_data.NFs['20'].NumEndPre = emitente.querySelector('#nro').value.trim().toUpperCase()
        main_data.NFs['20'].ComplEndPre = emitente.querySelector('#cpl').value.trim().toUpperCase()
        main_data.NFs['20'].BairroPre = emitente.querySelector('#bairro').value.trim().toUpperCase()
        main_data.NFs['20'].MunPre = emitente.querySelector('#xMun').value.trim().toUpperCase()
        main_data.NFs['20'].SiglaUFPre = emitente.querySelector('#UF').value.trim().toUpperCase()
        main_data.NFs['20'].CepPre = getNum(emitente.querySelector('#CEP').value)
        main_data.NFs['20'].EmailPre = emitente.querySelector('#email').value.trim().toLowerCase()
        NFeConf(main_data.NFs,'NFs.json')
    })

    document.querySelector('#btnSaveCli').addEventListener('click',()=>{
        const cliente = document.querySelector('#cliente')
        main_data.NFs['20'].RazSocTom = cliente.querySelector('#xNome').value.trim().toUpperCase()
        main_data.NFs['20'].TipoCpfCnpjTom = '2'
        main_data.NFs['20'].CpfCnpjTom = getNum(cliente.querySelector('#CNPJ').value)
        main_data.NFs['20'].LogTom = cliente.querySelector('#xLgr').value.trim().toUpperCase()
        main_data.NFs['20'].NumEndTom = cliente.querySelector('#nro').value.trim().toUpperCase()
        main_data.NFs['20'].ComplEndTom = cliente.querySelector('#cpl').value.trim().toUpperCase()
        main_data.NFs['20'].BairroTom = cliente.querySelector('#bairro').value.trim().toUpperCase()
        main_data.NFs['20'].MunTom = cliente.querySelector('#xMun').value.trim().toUpperCase()
        main_data.NFs['20'].SiglaUFTom = cliente.querySelector('#UF').value.trim().toUpperCase()
        main_data.NFs['20'].CepTom = getNum(cliente.querySelector('#CEP').value)
        main_data.NFs['20'].EMailTom = cliente.querySelector('#email').value.trim().toLowerCase()
        NFeConf(main_data.NFs,'NFs.json')
    })

    document.querySelector('#txtFiles').addEventListener('dblclick',()=>{
        const file = document.getElementById('txtFiles').value
        const path = 'assets/NFs/txt/' + file;
        var link = document.createElement("a");
            link.download = file;
            link.href = path;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link; 
    })

    document.querySelector('#xmlFiles').addEventListener('dblclick',()=>{
        const file = document.getElementById('xmlFiles').value
        const path = 'assets/NFs/xml/' + file;
        var link = document.createElement("a");
            link.download = file;
            link.href = path;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link; 
    })

    document.querySelector('#btnBusca').addEventListener('click',()=>{

        const sel = document.querySelector('#cmbBusca')
        const field = sel.value
        const signal = sel.options[sel.selectedIndex].getAttribute('signal')
        const ckb = document.querySelector('#ckbData').checked
        let value = sel.options[sel.selectedIndex].hasAttribute('val') ? sel.options[sel.selectedIndex].getAttribute('val') : document.querySelector('#edtBusca').value.trim()
        value = signal=='LIKE' ? `"%${value}%"` : signal=='IN' ? `(${value})` : sel.value=='true'? sel.value : `"${value}"`

        const tbl = document.getElementById('tblServExec')
        const params = new Object;
            params.field = field
            params.signal = signal
            params.value = value
            params.ini = ckb ? document.querySelector('#edtIni').value : '2000-01-01';
            params.fin = ckb ? document.querySelector('#edtFin').value : '2100-12-31';

        const myPromisse = queryDB(params,52);

        myPromisse.then((resolve)=>{
            if(resolve.trim() != ""){
                const json = JSON.parse(resolve);                
                tbl.head('Cod.|mobHide,Cliente,Carro,Data|mobHide,NF|mobHide,Valor R$|mobHide')                                             
                for(let i=0; i<json.length;i++){
                    tbl.plot(json[i],'id|mobHide,fantasia,num_carro,data_exec,nf|mobHide,valor|mobHide','int,Upp,str,date,str,R$.')
                }                               
            }        
        })
    })

    document.querySelector('#tblServExec').addEventListener('click',(e)=>{
        data = e.target.parentNode.data
        data.mode = 'edit'

        if (confirm(`Carregar Carro.${data.num_carro} de ${data.fantasia.toUpperCase()}?`)) {
            const cliente = document.querySelector('#cliente')
            cliente.querySelector('#xNome').value = data.razao_social.trim().toUpperCase()
            cliente.querySelector('#CNPJ').value = getCNPJ(data.cnpj)
            cliente.querySelector('#xLgr').value = data.endereco.trim().toUpperCase()
            cliente.querySelector('#nro').value = data.num.trim().toUpperCase()
            cliente.querySelector('#bairro').value = data.bairro.trim().toUpperCase()
            cliente.querySelector('#cpl').value = ''
            cliente.querySelector('#xMun').value = data.cidade.trim().toUpperCase()
            cliente.querySelector('#UF').value = data.estado.trim().toUpperCase()
            cliente.querySelector('#CEP').value = getCEP(data.cep)
            cliente.querySelector('#email').value = ''
            document.querySelector('#btnSaveCli').click()
            const serv = document.querySelector('#txtServicos')
            if(serv.innerHTML.trim() == ''){
                serv.innerHTML = `CARRO:${data.num_carro}\n` + data.obs +'\n'
                document.querySelector('#edtValor').value = data.valor

            }else if (confirm(`Adicionar o carro ${data.num_carro} a NFs atual?`)){
                serv.innerHTML += `\nCARRO:${data.num_carro}\n` + data.obs +'\n'
                document.querySelector('#edtValor').value =  (parseFloat(document.querySelector('#edtValor').value)+parseFloat(data.valor)).toFixed(2)

            }
            document.querySelector('#tab-cliente').click()
        }



    })

</script>