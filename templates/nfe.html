
<template>
    <style>




    .tab-bar{
        display: flex;
    }

    .tab-screen{
        overflow: scroll;
        border: solid;
        width: 100%;
        height: 80vh;
        margin-top: 0px;
    }

    .tab-item{
        margin: 20px 0 0 0;
        padding: 15px 15px 5px 15px;
        border: rgb(10, 10, 10) solid;
        border-radius: 15px 15px 0 0;
    }

    .tab-item:hover{
        background-color: #FFF8DC;
        cursor: pointer;
    }

    .tab-item:target{
        background-color: #3F5954;
        color: ghostwhite;
        font-size: large;
    }

    #fiscal > *{
        display: flex;
        flex-direction: column;
        width: 98%;
        margin-left: 10px;  
        margin-top: 10px;      
    }

    #fiscal > label{
        margin-left: 20px;
    }


    button{
        width: 98%;
    }



    </style>
  
  <div class="form-base">
    <h1>NFe Venda</h1>
    <div style="margin: 50px;">
    
        <div class="tab-bar">
            <div class="tab-item tab-emitente" style="background: #3F5954; color:#FFF8DC;" > Emitente</div>
            <div class="tab-item tab-fiscal" >Fiscal</div>
            <div class="tab-item tab-pedido" >Pedido</div>
            <div class="tab-item tab-cliente" >Cliente</div>            
            <div class="tab-item tab-itens" >Itens</div>
            <div class="tab-item tab-fatura" >Faturamento</div>
            <div class="tab-item tab-export" >Arquivos TXT</div>
        </div>
        
        <div class="tab-screen">        
            <div id="emitente" class="tab emitente">
<!--                <h2>Emitente</h2>               -->
                <div id="C">
                    <div class="inline">
                        <label> Razão Social *</label>
                        <input type="text" id="xNome" maxlength="60" />
                    </div>
                    <div class="inline">
                        <label> Nome Fantasia </label>
                        <input type="text" id="xFant" maxlength="60" />
                    </div>    

                    <div class="inline">
                        <label> Insc. Estadual </label>
                        <input type="text" id="IE" maxlength="15" onkeyup="valIE(this)"/>
                        <input type="hidden" id="IEST" >                
                        <label> Insc. Municipal </label>
                        <input type="text" id="IM" maxlength="15" onkeyup="valInt(this)"/>
                    </div> 
                    <div class="inline">
                        <label> Regime Trib. </label>
                        <select id="CRT" >
                          <option value="1" selected>Simples Nacional</option>
                          <option value="2" >Simples Nacional - excesso de sublimite de receita bruta</option>
                          <option value="3" >Regime Normal.</option>
                        </select>
                        <label> CNAE </label>
                        <input type="text" id="CNAE" maxlength="7" onkeyup="valInt(this)"/>                        
                    </div>                                                       
                </div>
                <div id="C02" class="inline">
                    
                    <label> CNPJ </label>
                    <input type="text" id="CNPJ" maxlength="18" onkeyup="valCNPJ(this)"/>
                </div>
                <div id="C05">
                    <div class="inline">
                        <label> Endereço </label>
                        <input type="text" id="xLgr" maxlength="60" />
                        <label> Número: </label>
                        <input type="text" id="nro" maxlength="5" style="max-width: 100px;" />
                    </div>
                    <div class="inline">
                        <label> Bairro </label>
                        <input type="text" id="bairro" maxlength="60" />
                        <label> Complemento </label>
                        <input type="text" id="cpl" maxlength="60" style="max-width: 200px;" />
                    </div>
                    <div class="inline">
                        <label> Municipio</label>
                        <input type="text" id="xMun" maxlength="60" />
                        <label> Código</label>
                        <input type="text" id="cMun" maxlength="7" style="max-width: 150px;" onkeyup="valInt(this)" />
                        <label> Sigla da UF </label>
                        <input type="text" id="UF" maxlength="2" style="max-width: 50px;" />
                    </div>
                    <div class="inline">
                        <label> Nome do País </label>
                        <input type="text" id="xPais" maxlength="60" />
                        <label> Código </label>
                        <input type="text" id="cPais" maxlength="4" onkeyup="valInt(this)"/>
                    </div>
                    <div class="inline">
                        <label> CEP </label>
                        <input type="text" id="CEP" maxlength="8" onkeyup="valCEP(this)"/>
                        <label> Telefone </label>
                        <input type="text" id="fone" maxlength="14" onkeyup="phone(this)"/>
                    </div>
                </div>
                <button id="btnSaveEmit">Salvar</button>
                                
            </div>            
            <div id="fiscal" class="tab fiscal" style="display:none">
<!--                <h2>Fiscal</h2>-->
            
                <div id="B">

                    <input type="hidden" id="cUF" value="35">
                    <input type="hidden" id="cNF">
                    <input type="hidden" id="serie" value="1">
                    <input type="hidden" id="cMunFG">
                    <input type="hidden" id="cDV">
                    <input type="hidden" id="verProc">
                    <input type="hidden" id="dhCont">
                    <input type="hidden" id="xJust">
                
                    <label> Numero da NF</label>    
                    <input type="text" id="nNF" maxlength="9" />

                    <label> Nat. Operação *</label>
                    <input type="text" id="natOp" maxlength="60" />
    
                    <label> Código do Modelo do Documento Fiscal </label>
                    <input type="text" id="mod" maxlength="2" value=""/>
                    
                    <label> Data de emissão do Documento Fiscal </label>
                    <input type="date" id="dhEmi" value="" >
    
                    <label> Data e hora de Saída ou da Entrada da Mercadoria/Produto </label>
                    <input type="date" id="dhSaiEnt" value="">
    
                    <label> Tipo de Operação</label>
                    <select id="tpNF" >
                      <option value="0" selected>Entrada</option>
                      <option value="1">Saída</option>
                    </select>
    
                    <label> Identificador de Local de destino da operação</label>
                    <select id="idDest" >
                      <option value="1">Operação Interna</option>
                      <option value="2">Operação Interestadual</option>
                      <option value="3">Operação com o Exterior</option>
                    </select>
        
                    <label> Formato de Impressão do DANFE</label>
                    <select id="tpImp" >
                      <option value="1">Retrato</option>
                      <option value="2">Paisagem</option>
                    </select>
    
                    <label>Tipo de Emissão da NF-e</label>
                    <select id="tpEmis" >
                      <option value="1">Normal</option>
                      <option value="2">Contingência FS - emissão em contingência com impressão do DANFE em Formulário de Segurança</option>
                      <option value="4">Contingência EPEC - emissão em contingência com envio da Evento Prévio de Emissão em Contingência - EPEC</option>
                      <option value="5">Contingência FS-DA - emissão em contingência com impressão do DANFE em Formulário de Segurança para Impressão de Documento Auxiliar de Documento Fiscal Eletrônico (FS-DA)</option>
                      <option value="6">Contingência SVC-AN</option>
                      <option value="7">Contingência SVC-RS</option>
                      <option value="9">Contingência off-line NFC-e</option>
                    </select>
        
                    <label> Identificação do Ambiente</label>
                    <select id="tpAmb" >
                      <option value="1">Produção</option>
                      <option value="2">Homologação</option>
                    </select>
    
                    <label> Finalidade de emissão da NF-e</label>
                    <select id="finNFe" >
                      <option value="1">NF-e normal</option>
                      <option value="2">NF-e complementar</option>
                      <option value="3">NF-e de ajuste</option>
                    </select>
    
                    <label>Indica operação com o consumidor final</label>
                    <select id="indFinal" >
                      <option value="0">Normal</option>    
                      <option value="1">Consumidor Final</option>
                    </select>
    
                    <label>Indicador de presença do comprador no estabelecimento comercial no momento da operação</label>
                    <select id="indPres" >
                      <option value="0">Não se aplica (por exemplo Nota Fiscal Complementar ou de ajuste)</option>
                      <option value="1">Operação presencial</option>
                      <option value="2">Operação não presencial, pela Internet</option>
                      <option value="3">Operação não presencial, pelo tele atendimento</option>
                      <option value="4">NFC-e em operação com entrega em domicílio</option>
                      <option value="5">Operação não presencial, fora do estabelecimento</option>
                      <option value="9">Operação não presencial, outros</option>
                    </select>
    
                    <label>Processo de emissão da NF-e</label>
                    <select id="procEmi" >
                      <option value="0">emissão de NF-e com aplicativo do contribuinte</option>
                      <option value="1">emissão de NF-e avulsa pelo Fisco</option>
                      <option value="2">emissão de NF-e avulsa, pelo contribuinte com seu certificado digital, através do site do Fisco</option>
                      <option value="3">emissão NF-e pelo contribuinte com aplicativo fornecido pelo Fisco</option>
                    </select>

                    <div class="ckBOX">
                        <label for="ckbSimpRem">Simples Remessa </label>                 
                        <input type='checkbox' id='ckbSimpRem' /> 
                    </div>  
                </div>                
  
                  <button id="btnSaveFiscal">Salvar</button>                
            </div>            
            <div id="pedido" class="tab pedido" style="display:none">
<!--                <h2>Pedido</h2>-->

                <fieldset>
                    <legend>Busca Por</legend>
                    <div class="inline">
                        <select id="selBuscaPed">
                            <option value="true"       signal="=" val="true"   >Todos      </option>                        
                            <option value="p.status"   signal="=" val="ABERTO" >Cotações   </option>
                            <option value="p.status"   signal="=" val="FECHADO" selected>Pedidos    </option>
                            <option value="p.status"   signal="=" val="PAGO"   >Faturados  </option>
                            <option value="p.status"   signal="=" val="INTERNO">Uso Interno</option>
                            <option value="p.id"       signal="IN"   >Códigos (vários)</option>
                            <option value="p.num_ped"  signal="LIKE">Num. do Pedido</option>
                            <option value="e.fantasia" signal="LIKE"   >Cliente (Nome Fantasia)</option>
                            <option value="e.nome"     signal="LIKE"   >Cliente</option>
                            <option value="e.id"       signal="IN"   >Cod. do Cliente</option>      
                        </select>
                        <input type="text" id="edtBuscaPed" />
                        <button id="btnBuscaPed" >OK</button>
                        </div>
                        <div class="inline center-itens">
                            <div class="ckBOX">
                                <label for="ckbData">Início/Final</label>
                                <input type="checkbox" id="ckbData" checked>
                            </div>
                            <input type="date" id="edtIni">
                            <input type="date" id="edtFin">
                        </div>                         
                     <table id="tblBuscaPed"></table> 
                </fieldset>

            </div>
            <div id="cliente" class="tab cliente" style="display:none">
<!--                <h2>Cliente</h2>-->
                <div id="E">
                    <div class="inline">
                        <label> Razão Social *</label>
                        <input type="text" id="xNome" maxlength="60"/>
                    </div>
                    <div class="inline">
                        <label> ICMS</label>
                        <select id="indIEDest">
                            <option value="1">Contribuinte ICMS (informar a IE do destinatário)</option>
                            <option value="2">Contribuinte isento de Inscrição no cadastro de Contribuintes do ICMS (Não possui IE)</option>
                            <option value="9">Não Contribuinte, que pode ou não possuir Inscrição Estadual no Cadastro de Contribuintes do ICMS</option>
                        </select>
                    </div>
                    <div class="inline">
                        <label> Insc. Estadual </label>
                        <input type="text" id="IE" maxlength="15" onkeyup="valIE(this)"/>
                        <input type="hidden" id="ISUF">
                        <label> Insc. Municipal </label>
                        <input type="text" id="IM" maxlength="15" onkeyup="valInt(this)"/>                 
                    </div>
                    <div class="inline">
                        <label> Email </label>
                        <input type="text" id="email"/>
                    </div>

                </div>                           
                <div id="E02" class="inline">
                    <label> CNPJ </label>
                    <input type="text" id="CNPJ" maxlength="18" onkeyup="valCNPJ(this)"/>
                </div>
                <div id="E05">
                    <div class="inline">
                        <label> Endereço </label>
                        <input type="text" id="xLgr" maxlength="60"/>
                        <label> Número: </label>
                        <input type="text" id="nro" maxlength="5" style="width: 100px;" />    
                    </div>
                    <div class="inline">
                        <label> Bairro </label>
                        <input type="text" id="xBairro" maxlength="60"/>
                        <label> Complemento </label>
                        <input type="text" id="XCpl" maxlength="60"/>
                    </div>
                    <div class="inline">
                        <label>  Municipio</label>
                        <input type="text" id="xMun" maxlength="60"/>
                        <label> Cod.</label>
                        <input type="text" id="cMun" maxlength="7" onkeyup="valInt(this)" style="width: 200px ;"/>
                        <label> Sigla da UF </label>
                        <input type="text" id="UF" maxlength="2" style="width: 70px ;"/>                        
                    </div>
                    <button id="btnBuscaIBGE"> Buscar no IBGE</button>
                    <div class="inline">
                        <label> País </label>
                        <input type="text" id="xPais" maxlength="15"/>                        
                        <label> Cod.</label>
                        <input type="text" id="cPais" maxlength="4"/>
                    </div>
                    <div class="inline">
                        <label> CEP </label>
                        <input type="text" id="CEP" maxlength="10" onkeyup="valCEP(this)"/>
                        <label> Telefone </label>
                        <input type="text" id="fone" maxlength="14" onkeyup="phone(this)"/>    
                    </div>
                </div>
                <button id="btnSaveCli">Salvar</button>
            </div>        
            <div id="itens" class="tab itens" style="display:none">
<!--                <h2>Itens</h2>-->
               
                <table id="tblItens"></table>

<!--                    <button id="btnTeste">Teste*</button> -->


            </div>            
            <div id="fatura" class="tab fatura" style="display:none">
<!--                <h2>Faturamento</h2>-->
                <div id="W">

                    <fieldset>
                        <legend>Dados de Fatura</legend>
                        <div class="inline">
                            <label>Valor da NF</label>
                            <input type="text" id="edtValorNF" value="0.00" onkeyup="valFloat(this)">
                            <label>Dias entre as Parcelas</label>
                            <input type="text" id="edtDiasParcelas" value="30/45/60">
                            <label>Desconto</label>
                            <input type="text" id="edtDesconto" value="0" onkeyup="valFloat(this)">
                        </div>                        
                        <label class="inline">Texto Complementar</label>
                        <textarea  id="txaTextoCompl" rows="10"></textarea>                    
                    </fieldset>

                    <button id="btnGeraNFe">Gerar NFe</button>
                </div>
            </div>
            <div id="export" class="tab export" style="display:none">
<!--                <h2>Arquivos TXT</h2>-->

                    <fieldset>
                        <legend>Arquivos TXT</legend>
                        <select id="txtFiles" size="20"></select>
                        <button id="btnExportNFe">Exportar</button>                    
                    </fieldset>
            </div>                
        </div>   
    </div> 

</div>

</template>
<script>

/*  GLOBAL  */

//    let NFe

/* CHAMADA DE FUNÇÕES INICIAL */    

    importData()
    document.querySelector('#edtIni').value =  today.iniMonth()
    document.querySelector('#edtFin').value =  today.finMonth()

    function somaNFeItens(){
        let tot = 0
        const tbl = document.querySelector('#tblItens').rows
        for(let i=1; i<tbl.length; i++){
            let val = parseFloat(tbl[i].cells[4].innerHTML) 
            val = val == NaN ? 0 : val
            tot += val
        }
        document.querySelector('#edtValorNF').value = tot.toFixed(2)
    }

    function geraNFeItens(){
        const tblItens = document.querySelector('#tblItens').rows
        main_data.NFe.itens = []
        for(let i=1; i< tblItens.length; i++){
            console.log(tblItens[i].data)
            const H = new Object
            H.nItem = i
            H.infAdProd = ''
// I|cProd|cEAN|xProd|NCM|cBenef|EXTIPI|CFOP|uCom|qCom|vUnCom|vProd|cEANTrib|uTrib|qTrib|vUnTrib| vFrete|vSeg|vDesc|vOutro| indTot| xPed|nItemPed|nFCI|
            H.I = new Object
            H.I.cProd = tblItens[i].data.cod_prod
            H.I.cEAN = '|'
            H.I.xProd = tblItens[i].data.descricao.trim()
            H.I.NCM = tblItens[i].data.ncm
            H.I.cBenef = ''
            H.I.CFOP = tblItens[i].data.cfop
            H.I.uCom = tblItens[i].data.und
            H.I.qCom = parseFloat(tblItens[i].data.qtd).toFixed(4)
            H.I.vUnCom = parseFloat(tblItens[i].data.preco).toFixed(10)
            H.I.vProd = parseFloat(tblItens[i].data.total).toFixed(2)
            H.I.cEANTrib =  '|'
            H.I.uTrib = tblItens[i].data.und
            H.I.qTrib = parseFloat(tblItens[i].data.qtd).toFixed(4)
            H.I.vUnTrib = parseFloat(tblItens[i].data.preco).toFixed(10)
            H.I.vFrete = ''
            H.I.vSeg = ''
            H.I.vDesc = ''
            H.I.vOutro = ''
            H.I.indTot = '1'
            H.I.xPed = ''
            H.I.nItemPed = ''
            H.I.nFCI = ''
            H.M = new Object
            H.M.a = ''
            H.M.b = ''
            H.N = new Object    
//N10d|orig|CSOSN|
            H.N10d = new Object
            H.N10d.orig = '0'
            H.N10d.CSOSN = '102'
//O|CNPJProd|cSelo|qSelo|cEnq|                
            H.O = new Object
            H.O.CNPJProd = ''
            H.O.cSelo = ''
            H.O.qSelo = ''
            H.O.cEnq = '999'
//O07|CST|vIPI|                
            H.O07 = new Object
            H.O07.CST = '99'
            H.O07.vIPI = '0.00'
//O10|vBC|pIPI|
            H.O10 = new Object
            H.O10.vBC = '0.00'
            H.O10.pIPI = '0.0000'
            H.Q = new Object
//Q05|CST|vPIS|            
            H.Q05 = new Object
            H.Q05.CST = '99'
            H.Q05.vPIS = '0.00'
//Q07|vBC|pPIS|                
            H.Q07 = new Object
            H.Q07.vBC = '0.00'
            H.Q07.pPIS = '0.0000'
            H.S = new Object
//S05|CST|vCOFINS|            
            H.S05 = new Object
            H.S05.CST = '99'
            H.S05.vCOFINS = '0.00'
//S07|vBC|pCOFINS|
            H.S07 = new Object
            H.S07.vBC = '0.00'
            H.S07.pCOFINS = '0.0000'
            main_data.NFe.itens.push(H)
        }

        main_data.NFe.W = new Object
//W02|vBC|vICMS|vICMSDeson|vFCPUFDest|vICMSUFDest|vICMSUFRemet|vFCP|vBCST|vST|vFCPST|vFCPSTRet|vProd|vFrete|vSeg|vDesc|vII|vIPI|vIPIDevol|vPIS|vCOFINS|vOutro|vNF|vTotTrib|
        main_data.NFe.W02 = new Object
        main_data.NFe.W02.vBC = '0.00'
        main_data.NFe.W02.vICMS = '0.00'
        main_data.NFe.W02.vICMSDeson = '0.00'
//        main_data.NFe.W02.vFCPUFDest = '0.00'
//        main_data.NFe.W02.vICMSUFDest = '0.00'
        main_data.NFe.W02.vICMSUFRemet = '0.00'
        main_data.NFe.W02.vFCP = '0.00'
        main_data.NFe.W02.vBCST = '0.00'
        main_data.NFe.W02.vST = '0.00'
        main_data.NFe.W02.vFCPST = '0.00'
//        main_data.NFe.W02.vFCPSTRet = '0.00'
        main_data.NFe.W02.vProd = parseFloat(document.querySelector('#edtValorNF').value).toFixed(2)
        main_data.NFe.W02.vFrete = '0.00'
        main_data.NFe.W02.vSeg = '0.00'
        main_data.NFe.W02.vDesc = '0.00'
        main_data.NFe.W02.vII = '0.00'
        main_data.NFe.W02.vIPI = '0.00'
        main_data.NFe.W02.vIPIDevol = '0.00'
        main_data.NFe.W02.vPIS = '0.00'
        main_data.NFe.W02.vCOFINS = '0.00'
        main_data.NFe.W02.vOutro = '0.00'
        main_data.NFe.W02.vNF = parseFloat(document.querySelector('#edtValorNF').value).toFixed(2)
        main_data.NFe.W02.vTotTrib = '0.00'
//Y02|nFat|vOrig|vDesc|vLiq|
        const parc = document.querySelector('#edtDiasParcelas').value.split('/')
        const valor = parseFloat(document.querySelector('#edtValorNF').value)
        const desc = parseFloat(document.querySelector('#edtDesconto').value)
        main_data.NFe.Y02 = new Object
        main_data.NFe.Y02.nFat = parc.length
        main_data.NFe.Y02.vOrig = valor.toFixed(2)
        main_data.NFe.Y02.vDesc = desc.toFixed(2)
        main_data.NFe.Y02.vLiq = (valor - desc).toFixed(2)
        NFeConf(main_data.NFe)
    }

    main_data.nfe.row_edit = function(obj){
        main_data.nfe.row_item.cells[1].innerHTML = obj.descricao
        main_data.nfe.row_item.cells[2].innerHTML = obj.qtd
        main_data.nfe.row_item.cells[3].innerHTML = obj.preco
        main_data.nfe.row_item.cells[4].innerHTML = obj.total
        main_data.nfe.row_item.cells[5].innerHTML = obj.cfop
        somaNFeItens()
    }

    document.querySelector('#tblItens').addEventListener('click',(e)=>{
        data = e.target.parentNode.data
        data.mode = 'edtItens'

        main_data.nfe.row_item = e.target.parentNode



        openHTML('viewNFeItens.html','pop-up','Edição de Ítem de NFe',data)


    })

    document.querySelector('#tblBuscaPed').addEventListener('click',(e)=>{
        data = e.target.parentNode.data
        data.mode = 'NFe'

        if (confirm(`Carregar Ped.${data.num_ped} de ${data.fantasia.toUpperCase()}?`)) {
            console.log(data)

            function addCli(){
                const cliente = document.querySelector('#cliente')
                cliente.querySelector('#xNome').value = data.nome_emp.trim().toUpperCase()
                cliente.querySelector('#indIEDest').value = (data.ie==null || data.ie.trim() == '') ? 2 : 1
                cliente.querySelector('#IE').value = data.ie!=null ? getIE(data.ie) : ''
                cliente.querySelector('#IM').value = data.im!=null ? data.im.trim().toUpperCase() : ''
                cliente.querySelector('#CNPJ').value = getCNPJ(data.cnpj)
                cliente.querySelector('#xLgr').value = data.endereco!=null ? data.endereco.trim().toUpperCase() : ''
                cliente.querySelector('#nro').value = data.num!=null ? data.num.trim().toUpperCase() : ''
                cliente.querySelector('#XCpl').value = data.comp!= null ? data.comp.trim().toUpperCase() : ''
                cliente.querySelector('#xBairro').value = data.bairro!=null ? data.bairro.trim().toUpperCase() : ''
                cliente.querySelector('#xMun').value = data.cidade!=null ? data.cidade.trim().toUpperCase() : ''
                cliente.querySelector('#UF').value = data.estado.trim().toUpperCase()
                cliente.querySelector('#CEP').value = data.cep!=null ? getCEP(data.cep) : ''
                cliente.querySelector('#cPais').value = '1058'
                cliente.querySelector('#xPais').value = 'BRASIL'
                cliente.querySelector('#fone').value = getFone(data.tel)
                document.getElementById('btnBuscaIBGE').click()
//                document.getElementById('btnSaveCli').click()

            }    

            const params = new Object;
                params.ped_id = data.id
            const myPromisse = queryDB(params,30);
            myPromisse.then((resolve)=>{
                const json = JSON.parse(resolve)
                const tbl = document.querySelector('#tblItens')
                let total
                if(tbl.rows.length > 0){
                    total = parseFloat(document.querySelector('#edtValorNF').value)
                    if (!confirm(`Adicionar os ítens deste pedido a NFe atual?`)) {
                        total = 0
                        tbl.head('Cod.|mobHide,Descrição,Qtd.,Preço Unit.,Sub Total,CFOP')
                        addCli()
                    }
                }else{
                    total = 0
                    tbl.head('Cod.|mobHide,Descrição,Qtd.,Preço Unit.,Sub Total,CFOP') 
                    addCli()           
                }

                for(let i=0; i<json.length;i++){
//                    console.log(json[i])
                    total += parseFloat(json[i].total)
                    let CFOP = ''
                    if(data.estado.trim().toUpperCase() == main_data.NFe.C05.UF){
                        CFOP = '51'
                    }else{
                        CFOP = '61'
                    }

                    if(json[i].id_emp == '13'){
                        CFOP += '01'
                    }else{
                        CFOP += '02'
                    }

                    json[i].cfop = CFOP

                    tbl.plot(json[i],'cod_prod|mobHide,descricao,qtd,preco,total,cfop','str,Upp,str,float,float,str')
                }
                document.querySelector('#edtValorNF').value = total.toFixed(2)
            })

        }

//        openHTML('viewCot.html','pop-up','Cotação',data)
    })

    document.querySelector('#btnBuscaPed').addEventListener('click',()=>{

        const sel = document.querySelector('#selBuscaPed')
        const field = sel.value
        const signal = sel.options[sel.selectedIndex].getAttribute('signal')
        const ckb = document.querySelector('#ckbData').checked
        let value = sel.options[sel.selectedIndex].hasAttribute('val') ? sel.options[sel.selectedIndex].getAttribute('val') : document.querySelector('#edtBuscaPed').value.trim()
        value = signal=='LIKE' ? `"%${value}%"` : signal=='IN' ? `(${value})` : sel.value=='true'? sel.value : `"${value}"`

        const tbl = document.getElementById('tblBuscaPed')
        const params = new Object;
            params.field = field
            params.signal = signal
            params.value = value
            params.ini = ckb ? document.querySelector('#edtIni').value : '2000-01-01';
            params.fin = ckb ? document.querySelector('#edtFin').value : '2100-12-31';        

        const myPromisse = queryDB(params,27);
        myPromisse.then((resolve)=>{
            if(resolve.trim() != ""){
                const json = JSON.parse(resolve);
                tbl.innerHTML=''
                json.length > 0 ? tbl.head('Cod.|mobHide,Num.,Cliente.,Data,Status|mobHide,Valor R$|mobHide') : 0
                for(let i=0; i<json.length;i++){                                       
                    tbl.plot(json[i],'id|mobHide,num_ped,fantasia,data_ped,status|mobHide,venda|mobHide','int,str,Upp,date,change FECHADO=PED ABERTO=COT PAGO=FAT INTERNO=USO_INT. .=**,R$.',true)                    
                }                
            }        
        })
    })


    function openTab(tab) {
        let x = document.getElementsByClassName("tab");
        
        for (let i = 0; i < x.length; i++) {
            x[i].style.display = "none";  
        }
        x = document.getElementsByClassName(tab);
        for (let i = 0; i < x.length; i++) {
            x[i].style.display = "block";          
        } 
        x = document.getElementsByClassName("tab-item");
        for (let i = 0; i < x.length; i++) {
            x[i].style.background = "#FFF8DC";  
            x[i].style.color = "#3F5954";         
        }                     
        x = document.getElementsByClassName("tab-"+tab);
        for (let i = 0; i < x.length; i++) {
            x[i].style.background = "#3F5954"; 
            x[i].style.color = "#FFF8DC";         
        }                    
    }

/* CHAMADA DE FUNÇÕES DO DOM */    

    document.querySelector('.tab-emitente').addEventListener('click',()=>{
        openTab('emitente')
    })
    document.querySelector('.tab-fiscal').addEventListener('click',()=>{
        openTab('fiscal')
    })
    document.querySelector('.tab-pedido').addEventListener('click',()=>{
        openTab('pedido')
    })
    document.querySelector('.tab-cliente').addEventListener('click',()=>{
        openTab('cliente')
    })    
    document.querySelector('.tab-itens').addEventListener('click',()=>{
        openTab('itens')
    })
    document.querySelector('.tab-fatura').addEventListener('click',()=>{
        openTab('fatura')
    })
    
    document.querySelector('.tab-export').addEventListener('click',()=>{
        openTab('export');                         
    })


    function importData(){
        NFeConf().then((txt)=>{
            main_data.NFe = JSON.parse(txt)

            const emitente = document.querySelector('#emitente')            
            emitente.querySelector('#xNome').value = main_data.NFe.C.xNome
            emitente.querySelector('#xFant').value = main_data.NFe.C.xFant
            emitente.querySelector('#IE').value = getIE(main_data.NFe.C.IE)
            emitente.querySelector('#IEST').value = main_data.NFe.C.IEST
            emitente.querySelector('#IM').value = main_data.NFe.C.IM
            emitente.querySelector('#CNAE').value = main_data.NFe.C.CNAE
            emitente.querySelector('#CRT').value = main_data.NFe.C.CRT
            emitente.querySelector('#CNPJ').value = getCNPJ(main_data.NFe.C02.CNPJ)
            emitente.querySelector('#xLgr').value = main_data.NFe.C05.xLgr
            emitente.querySelector('#nro').value = main_data.NFe.C05.nro
            emitente.querySelector('#bairro').value = main_data.NFe.C05.bairro
            emitente.querySelector('#cpl').value = main_data.NFe.C05.cpl
            emitente.querySelector('#xMun').value = main_data.NFe.C05.xMun
            emitente.querySelector('#cMun').value = main_data.NFe.C05.cMun
            emitente.querySelector('#UF').value = main_data.NFe.C05.UF
            emitente.querySelector('#xPais').value = main_data.NFe.C05.xPais
            emitente.querySelector('#cPais').value = main_data.NFe.C05.cPais
            emitente.querySelector('#CEP').value = getCEP(main_data.NFe.C05.CEP)
            emitente.querySelector('#fone').value = getFone(main_data.NFe.C05.fone)
            emitente.querySelector('#xMun').value = main_data.NFe.C05.xMun
            
            const fiscal = document.querySelector('#fiscal')            
            fiscal.querySelector('#nNF').value = parseInt(main_data.NFe.B.nNF) + 1
            fiscal.querySelector('#cNF').value = main_data.NFe.B.cNF
            fiscal.querySelector('#cUF').value = main_data.NFe.B.cUF
            fiscal.querySelector('#natOp').value = main_data.NFe.B.natOp
            fiscal.querySelector('#mod').value = main_data.NFe.B.mod
            fiscal.querySelector('#serie').value = main_data.NFe.B.serie
            fiscal.querySelector('#dhEmi').value = today.getFormatDate()
            fiscal.querySelector('#dhSaiEnt').value = today.getFormatDate()
            fiscal.querySelector('#tpNF').value = main_data.NFe.B.tpNF
            fiscal.querySelector('#idDest').value = main_data.NFe.B.idDest
            fiscal.querySelector('#cMunFG').value = main_data.NFe.B.cMunFG
            fiscal.querySelector('#tpImp').value = main_data.NFe.B.tpImp
            fiscal.querySelector('#tpEmis').value = main_data.NFe.B.tpEmis
            fiscal.querySelector('#cDV').value = main_data.NFe.B.cDV
            fiscal.querySelector('#tpAmb').value = main_data.NFe.B.tpAmb
            fiscal.querySelector('#finNFe').value = main_data.NFe.B.finNFe
            fiscal.querySelector('#indFinal').value = main_data.NFe.B.indFinal
            fiscal.querySelector('#indPres').value = main_data.NFe.B.indPres
            fiscal.querySelector('#procEmi').value = main_data.NFe.B.procEmi
            fiscal.querySelector('#verProc').value = main_data.NFe.B.verProc
            fiscal.querySelector('#dhCont').value = main_data.NFe.B.dhCont
            fiscal.querySelector('#xJust').value = main_data.NFe.B.xJust
        })

    }

    document.getElementById('btnSaveEmit').addEventListener('click',(event)=>{
        const emitente = document.querySelector('#emitente')
        main_data.NFe.C.xNome = emitente.querySelector('#xNome').value.trim().toUpperCase()
        main_data.NFe.C.xFant = emitente.querySelector('#xFant').value.trim().toUpperCase()
        main_data.NFe.C.IE = getNum(emitente.querySelector('#IE').value)
        main_data.NFe.C.IEST = emitente.querySelector('#IEST').value.trim().toUpperCase()
        main_data.NFe.C.IM = getNum(emitente.querySelector('#IM').value)
        main_data.NFe.C.CNAE = getNum(emitente.querySelector('#CNAE').value)
        main_data.NFe.C.CRT = emitente.querySelector('#CRT').value.trim().toUpperCase()
        main_data.NFe.C02.CNPJ = getNum(emitente.querySelector('#CNPJ').value)
        main_data.NFe.C05.xLgr = emitente.querySelector('#xLgr').value.trim().toUpperCase()
        main_data.NFe.C05.nro = emitente.querySelector('#nro').value.trim().toUpperCase()
        main_data.NFe.C05.cpl = emitente.querySelector('#cpl').value.trim().toUpperCase()
        main_data.NFe.C05.bairro = emitente.querySelector('#bairro').value.trim().toUpperCase()
        main_data.NFe.C05.cMun = getNum(emitente.querySelector('#cMun').value)
        main_data.NFe.C05.xMun = emitente.querySelector('#xMun').value.trim().toUpperCase()
        main_data.NFe.C05.UF = emitente.querySelector('#UF').value.trim().toUpperCase()
        main_data.NFe.C05.CEP = getNum(emitente.querySelector('#CEP').value)
        main_data.NFe.C05.cPais = getNum(emitente.querySelector('#cPais').value)
        main_data.NFe.C05.xPais = emitente.querySelector('#xPais').value.trim().toUpperCase()
        main_data.NFe.C05.fone = getNum(emitente.querySelector('#fone').value)
        NFeConf(main_data.NFe)
    })
                
    document.getElementById('btnSaveFiscal').addEventListener('click',(event)=>{
        const fiscal = document.querySelector('#fiscal')
        main_data.NFe.A.versao = '4.00'
        main_data.NFe.A.id = ''
        main_data.NFe.A.indSinc = ''
        main_data.NFe.B.nNF = fiscal.querySelector('#nNF').value.trim()
        main_data.NFe.B.cUF = fiscal.querySelector('#cUF').value
        main_data.NFe.B.cNF = Math.floor(Math.random() * (99999999 - 10000000) + 10000000)
        document.querySelector('#fiscal').querySelector('#cNF').value = main_data.NFe.B.cNF
        main_data.NFe.B.natOp = fiscal.querySelector('#natOp').value.trim().toUpperCase()
        main_data.NFe.B.mod = fiscal.querySelector('#mod').value.trim()
        main_data.NFe.B.serie = fiscal.querySelector('#serie').value
        main_data.NFe.B.dhEmi = fiscal.querySelector('#dhEmi').value
        main_data.NFe.B.dhSaiEnt = fiscal.querySelector('#dhSaiEnt').value
        main_data.NFe.B.tpNF = fiscal.querySelector('#tpNF').value
        main_data.NFe.B.idDest = fiscal.querySelector('#idDest').value
        main_data.NFe.B.cMunFG = fiscal.querySelector('#cMunFG').value
        main_data.NFe.B.tpImp = fiscal.querySelector('#tpImp').value
        main_data.NFe.B.tpEmis = fiscal.querySelector('#tpEmis').value
        main_data.NFe.B.cDV = fiscal.querySelector('#cDV').value
        main_data.NFe.B.tpAmb = fiscal.querySelector('#tpAmb').value
        main_data.NFe.B.finNFe = fiscal.querySelector('#finNFe').value
        main_data.NFe.B.indFinal = fiscal.querySelector('#indFinal').value
        main_data.NFe.B.indPres = fiscal.querySelector('#indPres').value
        main_data.NFe.B.procEmi = fiscal.querySelector('#procEmi').value
        main_data.NFe.B.verProc = fiscal.querySelector('#verProc').value
        main_data.NFe.B.dhCont = fiscal.querySelector('#dhCont').value
        main_data.NFe.B.xJust = fiscal.querySelector('#xJust').value
        main_data.NFe.A.id = geraChave(main_data.NFe.B.nNF,main_data.NFe.B.cNF,main_data.NFe.C02.CNPJ)
        NFeConf(main_data.NFe)
    })
                
    document.getElementById('btnSaveCli').addEventListener('click',()=>{
        const cliente = document.querySelector('#cliente')
        main_data.NFe.E.xNome = cliente.querySelector('#xNome').value.trim().toUpperCase()
        main_data.NFe.E.indIEDest = cliente.querySelector('#indIEDest').value
        main_data.NFe.E.IE = getNum(cliente.querySelector('#IE').value)
        main_data.NFe.E.ISUF = cliente.querySelector('#ISUF').value
        main_data.NFe.E.IM = getNum(cliente.querySelector('#IM').value)
        main_data.NFe.E.email = cliente.querySelector('#email').value.trim().toLowerCase()
        main_data.NFe.E02.CNPJ = getNum(cliente.querySelector('#CNPJ').value)
        main_data.NFe.E05.xLgr = cliente.querySelector('#xLgr').value.trim().toUpperCase()
        main_data.NFe.E05.nro = cliente.querySelector('#nro').value
        main_data.NFe.E05.XCpl = cliente.querySelector('#XCpl').value.trim().toUpperCase()
        main_data.NFe.E05.xBairro = cliente.querySelector('#xBairro').value.trim().toUpperCase()
        main_data.NFe.E05.cMun = getNum(cliente.querySelector('#cMun').value)
        main_data.NFe.E05.xMun = cliente.querySelector('#xMun').value.trim().toUpperCase()
        main_data.NFe.E05.UF = cliente.querySelector('#UF').value.trim().toUpperCase()
        main_data.NFe.E05.CEP = getNum(cliente.querySelector('#CEP').value)
        main_data.NFe.E05.cPais = cliente.querySelector('#cPais').value.trim().toUpperCase()
        main_data.NFe.E05.xPais = cliente.querySelector('#xPais').value.trim().toUpperCase()
        main_data.NFe.E05.fone = getNum(cliente.querySelector('#fone').value)
        NFeConf(main_data.NFe)
    })

    document.querySelector('#btnGeraNFe').addEventListener('click',()=>{
        

        if(document.querySelector('#cliente').querySelector('#cMun').value.trim() != '' ){
            geraNFeItens()

        }else{
            alert('Favor verificar o campo código do município')
            openTab('cliente')
            document.querySelector('#cliente').querySelector('#cMun').focus()
        }


        

    })


    document.querySelector('#btnBuscaIBGE').addEventListener('click',()=>{
        IBGE_cMun(document.querySelector('#E05').querySelector('#xMun').value,document.querySelector('#E05').querySelector('#UF').value)
    })

    function IBGE_cMun(C,E){
        C = C.trim().toLowerCase()
        E = E.trim().toUpperCase()
        if(C != '' && E != ''){
            const UF_cod = new Promise((resolve,reject) =>{
                fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados")
                .then(function (response){
                    if (response.status === 200) { 
                        resolve(response.text());
                    } else { 
                        reject(new Error("Houve algum erro na comunicação com o servidor"));
                    } 
                })                    
            });   

            UF_cod.then((resolve)=>{
                const json = JSON.parse(resolve);
                for(let i=0; i<json.length; i++){
                    if(json[i].sigla == E){
                        const Mun_cod = new Promise((resolve,reject) =>{
                            fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${json[i].id}/municipios`)
                            .then(function (response){
                                if (response.status === 200) { 
                                    resolve(response.text());
                                } else { 
                                    reject(new Error("Houve algum erro na comunicação com o servidor"));
                                } 
                            })                    
                        }); 

                        Mun_cod.then((resolve)=>{
                            const json = JSON.parse(resolve);
                            for(let j=0; j<json.length; j++){
                                if(json[j].nome.trim().toLowerCase() == C){
                                    document.querySelector('#E05').querySelector('#cMun').value =  json[j].id;
                                    document.getElementById('btnSaveCli').click()
                                    break;
                                }
                            }
                        })                
                    }
                }
            })
        }else{
            alert('Favor preencher Nome do Município e Sigla da UF.')
        }
    }


    function geraChave(nNF,cNF,CNPJ){
            
            mes = today.getMonth().toString().padStart(2, '0');
            ano = today.getFullYear().toString().substr(2,2);
            const aamm = ano+mes;
            nNF = nNF.padStart(9, '0');
            const uf = "35";            // cUF - Código da UF do emitente do Documento Fiscal;
            const tpEmis = "1";         // tpEmis – forma de emissão da NF-e;
            const mod = "55";           // mod - Modelo do Documento Fiscal;
            const ser = "001";          // serie - Série do Documento Fiscal;    
            const chave = uf + aamm + CNPJ + mod + ser +  nNF + tpEmis + cNF ;
    
            let dv = 0;
            let mult = 2;
                for(let i = 1; i < chave.length+1; i++){
                    dv = dv + (chave[chave.length - i] * mult);
                    mult++;
    
                    if (mult > 9){
                    mult = 2;
                    }
                }
    
                let resto = dv % 11;
                dv = 11 - resto;
    
                if(dv > 9){
                    dv = 0;
                }
    
                return 'NFe'+chave+dv;
    
        }    

/*                
                document.getElementById('btnGeraNFe').addEventListener('click',(event)=>{
                    event.preventDefault();
                    geraNFE();
                })
                document.getElementById('btnBuscaPed').addEventListener('click',()=>{
                    const sel = document.getElementById('selBuscaPed');
                    const edt = document.getElementById('edtBuscaPed');
                    let query = "";      
            
                    if (sel.value == "todos"){
            
                        query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped
                                FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                                ON p.id_emp = e.id AND p.status = 'FECHADO' ORDER BY p.data_ped DESC ;`;
                    } else if (sel.value == "num_ped"){
                        query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped
                                FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                                ON p.id_emp = e.id AND p.num_ped = '${edt.value}' AND p.status = 'FECHADO';`;
                    } else if (sel.value == "cliente"){
                        query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped
                                FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                                ON p.id_emp = e.id AND e.nome LIKE '%${edt.value}%' AND p.status = 'FECHADO' ORDER BY p.data_ped DESC ;`;
            
                    } else if (sel.value == "cod"){
                        query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped
                                FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                                ON p.id_emp = e.id AND p.id = '${edt.value}' AND p.status = 'FECHADO';`;
                    } else if (sel.value == "varios"){
                        const aux =  edt.value.split('/');
            
                        query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped
                                FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                                ON p.id_emp = e.id AND p.id = '${edt.value}' AND p.status = 'FECHADO';`;
                        }            
            
                    const data = new URLSearchParams();        
                        data.append("query", query);
            
                    const resp = getData("ajax/ajax.php", data);
            
                    resp.then((json)=>{
                        const data = JSON.parse(json);
                        const tbl =  document.getElementById('tblBuscaPed');
                        tbl.innerHTML = "<tr> <th>Cod.</th> <th>Numero</th> <th>Cliente</th> <th>CNPJ</th> <th>Data</th></tr>";
            
                        for(let i=0; i<data.length; i++){
                            const row = document.createElement('tr');
                            row.className = 'tab-row';
                            const fields = ['id','num_ped','nome','cnpj','data_ped'];
            
                            for(let j=0; j< Object.entries(data[i]).length; j++){
                                const dados = Object.entries(data[i]);
                                const col = document.createElement('td');
                                if(!fields.includes(dados[j][0])){
                                    col.style = "display:none;"
                                }
                                col.innerHTML = dados[j][1];
                                row.appendChild(col);                        
                            }
                    
                            row.addEventListener('dblclick',(event)=>{
            
                                function soNum(C){
                                    let resp = '';
                                    let perm = ['0','1','2','3','4','5','6','7','8','9'];
                                    for(let i=0; i< C.length; i++){
                                        if(perm.includes(C[i])){
                                            resp += C[i]
                                        }
                                    }
                                    return resp;
                                }
            
                                let target = event.target;
                                while (target.nodeName != 'TR') {
                                    target = target.parentElement;
                                }
                                let row = target.cells; 
            
                                const pedido = [];
                                for(let k=0; k<row.length; k++){
                                    pedido.push(row[k].innerHTML);
                                }
                                console.log(pedido);
                                numPed = pedido[1];
            
                                const pedcod = pedido[0];
                                const query = ` SELECT p.cod, p.descricao, p.ncm, p.unidade, i.qtd, i.preco, p.tipo, i.und
                                                FROM tb_item_ped as i 
                                                INNER JOIN tb_produto AS p
                                                ON i.id_ped = ${pedcod}
                                                AND i.id_prod = p.id;`;
            
            
                                const data = new URLSearchParams();        
                                data.append("query", query);
            
                                const resp = getData("ajax/ajax.php", data);
            
                                resp.then((json)=>{
                                    const data = JSON.parse(json);
                                    const tab = document.getElementById('tblItens');
                                    tab.innerHTML = '';
                                    let total = 0;
                                    dadosNF.itens = [];
            
                                    for(let i=0; i<data.length; i++){ // 1x a cada item do 
                                        dadosNF.itens.push([])
// H|nItem|infAdProd|
                                        const H = new Object;
                                            H.COD = "H";
                                            H.nItem = i+1;
                                            H.infAdProd = "";
                                        dadosNF.itens[i].push(H);
// I|cProd|cEAN|xProd|NCM|cBenef|EXTIPI|CFOP|uCom|qCom|vUnCom|vProd|cEANTrib|uTrib|qTrib|vUnTrib|vFrete|vSeg|vDesc|vOutro|indTot|xPed|nItemPed|nFCI|
                                        const I = new Object;
                                            I.COD = "I";
                                            I.cProd = data[i].cod.trim();
                                            I.cEAN = "";
                                            I.novo01 = ""; // ???
                                            I.xProd = data[i].descricao.trim();
                                            I.NCM = data[i].ncm.trim();
                                            I.cBenef = "";
//                                            I.EXTIPI = "";
                                            I.CFOP = "5101";
                                            I.uCom = data[i].und.trim();
                                            I.qCom = parseFloat(data[i].qtd).toFixed(4) ;
                                            I.vUnCom = parseFloat(data[i].preco).toFixed(10);
                                            I.vProd = parseFloat(data[i].preco * data[i].qtd).toFixed(2);
                                            I.cEANTrib = "";
                                            I.novo02 = ""; // ???                                            
                                            I.uTrib = data[i].und.trim();
                                            I.qTrib = parseFloat(data[i].qtd).toFixed(4);
                                            I.vUnTrib = parseFloat(data[i].preco).toFixed(10);
                                            I.vFrete = "";
                                            I.vSeg = "";
                                            I.vDesc = "";
                                            I.vOutro = "";
                                            I.indTot = "";
                                            I.xPed = "";
                                            I.nItemPed = "";
                                            I.nFCI = "";
                                        dadosNF.itens[i].push(I);
// M|vTotTrib|
                                        const M = new Object;
                                            M.COD = "M";
                                            M.vTotTrib = '';
                                        dadosNF.itens[i].push(M);
// N|
                                        const N = new Object;
                                            N.COD = "N";
                                        dadosNF.itens[i].push(N);
// N10d|orig|CSOSN|
                                        const N10d = new Object;
                                            N10d.COD = "N10d";
                                            N10d.orig = '0';
                                            N10d.CSOSN = '102';
                                        dadosNF.itens[i].push(N10d);                            
// O|CNPJProd|cSelo|qSelo|cEnq|
                                        const O = new Object;
                                            O.COD = "O";
                                            O.CNPJProd = "";
                                            O.cSelo = "";
                                            O.qSelo = "";
                                            O.cEnq = "999";
                                        dadosNF.itens[i].push(O);
// O07|CST|vIPI|
                                        const O07 = new Object;
                                            O07.COD = "O07";
                                            O07.CST = "99";
                                            O07.vIPI = (0).toFixed(2);
                                        dadosNF.itens[i].push(O07);
// O10|vBC|pIPI|
                                        const O10 = new Object;
                                            O10.COD = "O10";
                                            O10.vBC = (0).toFixed(2);
                                            O10.pIPI = (0).toFixed(4);
                                        dadosNF.itens[i].push(O10);
// Q|
                                        const Q = new Object;
                                            Q.COD = "Q";
                                        dadosNF.itens[i].push(Q);
// Q05|CST|vPIS|
                                        const Q05 = new Object;
                                            Q05.COD = "Q05";
                                            Q05.CST = "99";
                                            Q05.vPIS = (0).toFixed(2);
                                        dadosNF.itens[i].push(Q05);
// Q07|vBC|pPIS|
                                        const Q07 = new Object;
                                            Q07.COD = "Q07";
                                            Q07.vBC = (0).toFixed(2);
                                            Q07.pPIS = (0).toFixed(4);
                                        dadosNF.itens[i].push(Q07);
// S|
                                        const S = new Object;
                                            S.COD = "S";
                                        dadosNF.itens[i].push(S);  
// S05|CST|vCOFINS|
                                        const S05 = new Object;
                                            S05.COD = "S05";
                                            S05.CST = "99";
                                            S05.vCOFINS = (0).toFixed(2);
                                        dadosNF.itens[i].push(S05);
// S07|vBC|pCOFINS|
                                        const S07 = new Object;
                                            S07.COD = "S07";
                                            S07.vBC = (0).toFixed(2);
                                            S07.pCOFINS = (0).toFixed(4);
                                            dadosNF.itens[i].push(S07);
//                                        console.log(data[i])
            
                                        const campos = Object.entries(data[i]);
                                        const perm = ['cod','descricao','ncn','und','qtd','preco'];
                                        if(i == 0){
                                            const row = document.createElement('tr');
                                            for(let j=0; j<campos.length; j++){ // passa campo a campo
                                                if(perm.includes(campos[j][0])){
                                                    const label = document.createElement('th');
//                                                    console.log(campos[j])
                                                    label.innerHTML = campos[j][0];
                                                    row.appendChild(label);
                                                }                                    
                                            }
                                            tab.appendChild(row)
                                        }
            
                                        const row = document.createElement('tr');
                                        for(let j=0; j<campos.length; j++){
                                            const col = document.createElement('td');
                                            if(!perm.includes(campos[j][0])){
                                                col.style.display = 'none';
                                            }
                                            col.innerHTML = campos[j][1];
            
                                            row.appendChild(col);
                                        }
                                        total += parseFloat(data[i].preco) * parseFloat(data[i].qtd) ;
//                                        console.log(data[i].preco) 
                                        tab.appendChild(row)
            
                                    }
                                    const row = document.createElement('tr');
                                    const col = document.createElement('th');
                                    col.colSpan = 5
                                    col.style.textAlign = "right";
                                    col.innerHTML = 'Total R$'+total.toLocaleString('pt-br', {minimumFractionDigits: 2});
                                    row.appendChild(col)
                                    tab.appendChild(row)
//                                    console.log(total.toLocaleString('pt-br', {minimumFractionDigits: 2}) )


// tela de fatura                                    
                                    document.getElementById('edtValorNF').value = total.toFixed(2);
                                    let txtComp = `DOC. EMITIDO POR ME OU EPP OPTANTE S.NACIONAL, NÃO GERA DIREITO A CREDITO FISCAL DE ISSQN E IPI, PERMITE O APROVEITAMENTO DE CREDITO DO ICMS NO VALOR DE  R$ ${(total * 0.0282).toFixed(2)} CORRESPONDENTE A ALIQUOTA DE 2,82% NOS TERMOS DO ARTIGO 23 DA LC 123.`;
                                    if(numPed.trim != ""){
                                        txtComp += ` Aprovado conforme pedido ${numPed}`;
                                    }


                                    document.getElementById('txaTextoCompl').innerHTML = txtComp;


                                    dadosNF.fatura = [];
//                                    dadosNF.fatura.push([]);
// W|                                    
                                    const W = new Object;
                                        W.COD = "W";
                                    dadosNF.fatura.push(W);                                    
// W02|vBC|vICMS|vICMSDeson|vFCPUFDest|vICMSUFDest|vICMSUFRemet|vFCP|vBCST|vST|vFCPST|vFCPSTRet|vProd|vFrete|vSeg|vDesc|vII|vIPI|vIPIDevol|vPIS|vCOFINS|vOutro|vNF|vTotTrib|
                                    const W02 = new Object;
                                        W02.COD = "W02";
                                        W02.vBC = (0).toFixed(2);
                                        W02.vICMS = (0).toFixed(2);
                                        W02.vICMSDeson = (0).toFixed(2);
                                        W02.vFCPUFDest = (0).toFixed(2);
                                        W02.vICMSUFDest = (0).toFixed(2);
                                        W02.vICMSUFRemet = (0).toFixed(2);
                                        W02.vFCP = (0).toFixed(2);
                                        W02.vBCST = (0).toFixed(2);
                                        W02.vST = total.toFixed(2); //
                                        W02.vFCPST = (0).toFixed(2);
                                        W02.vFCPSTRet = (0).toFixed(2);
                                        W02.vProd = (0).toFixed(2);
                                        W02.vFrete = (0).toFixed(2);
                                        W02.vSeg = (0).toFixed(2);
                                        W02.vDesc = (0).toFixed(2);
                                        W02.vII = (0).toFixed(2);
                                        W02.vIPI = (0).toFixed(2);
                                        W02.vIPIDevol = (0).toFixed(2);
                                        W02.vPIS = (0).toFixed(2);
                                        W02.vCOFINS = (0).toFixed(2);
                                        W02.vOutro = (0).toFixed(2);
                                        W02.vNF = total.toFixed(2); //
                                        W02.vTotTrib = (0).toFixed(2);
                                    dadosNF.fatura.push(W02);   
// X|modFrete|
                                    const X = new Object;
                                        X.COD = "X";
                                        X.modFrete = "0";
                                    dadosNF.fatura.push(X);
// Y|
                                    const Y = new Object;
                                        Y.COD = "Y";
                                    dadosNF.fatura.push(Y);
// Y02|nFat|vOrig|vDesc|vLiq|
                                    const Y02 = new Object;
                                        Y02.COD = "Y02";
                                        Y02.nFat = 1; // qtd parcelas
                                        Y02.vOrig = total.toFixed(2); // valor original da NF
                                        Y02.vDesc = (0).toFixed(2); // desconto
                                        Y02.vLiq = total.toFixed(2);  // valor com desconto
                                    dadosNF.fatura.push(Y02); 
// Y07|nDup|dVenc|vDup|
                                    const Y07 = new Object; // parcelas
                                        Y07.COD = "Y07";
                                        Y07.nDup = "";  // numero da parcela
                                        Y07.dVenc = ""; // data do vencimento aaaa-mm-dd
                                        Y07.vDup = (0).toFixed(2);  // valor da parcela toFixed(2)
                                    dadosNF.fatura.push(Y07); 
// YA|vTroco|
                                    const YA = new Object;
                                        YA.COD = "YA";
                                        YA.vTroco = "";
                                    dadosNF.fatura.push(YA); 
// Z|infAdFisco|infCpl|
                                    const Z = new Object;
                                        Z.COD = "Z";
                                        Z.infAdFisco = "";
                                        Z.infCpl = "";
                                    dadosNF.fatura.push(Z); 

//                                    console.log(dadosNF)


                                })
            
//                                console.log(query);
            
                                dadosNF.NF[6].xNome = pedido[2];
                                dadosNF.NF[6].IE = soNum(pedido[3]);
                                if(pedido[3].trim() != ''){
                                    dadosNF.NF[6].indIEDest = 1;
                                }else{
                                    dadosNF.NF[6].indIEDest = 2;
                                }
                                // dados do cliente do pedido
                                dadosNF.NF[7].CNPJ = soNum(pedido[4]);
                                dadosNF.NF[8].xLgr = pedido[5].trim();
                                dadosNF.NF[8].nro = pedido[7].trim();
                                dadosNF.NF[8].XCpl = '';
                                dadosNF.NF[8].xBairro = pedido[8].trim();
                                dadosNF.NF[8].xMun = pedido[9].trim();
                                dadosNF.NF[8].UF = pedido[10].trim();
                                dadosNF.NF[8].CEP = soNum(pedido[11]);
                                dadosNF.NF[8].cPais = '1058';
                                dadosNF.NF[8].fone = soNum(pedido[12]);
                                IBGE_cMun();
                                atualiza()
                                salvaNF("E",6);
                                salvaNF("E02",7);
                                salvaNF("E05",8);                    
                            })                    
                            tbl.appendChild(row);
                        }
            
                    })
                    
                })
                document.getElementById('btnBuscaIBGE').addEventListener('click',(event)=>{
                    event.preventDefault();
                    salvaNF("E05",8);
                    IBGE_cMun();
                })
                document.getElementById('btnExportNFe').addEventListener('click',()=>{

                    const file = document.getElementById('txtFiles').value;
                    const path = 'NF_txt/' + file;

                    
                    var link = document.createElement("a");
                        link.download = file;
                        link.href = path;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        delete link; 

   


                })            
/*                
                document.getElementById('btnTeste').addEventListener('click',()=>{                          
            })
             #3F5954; color:#FFF8DC


            
                function importData(){
                    const data = new URLSearchParams();        
                        data.append("path", "../config/nfe.json");
            
                    const resp = getData("ajax/ajax_getJson.php", data);
                    resp.then((json)=>{                 
                        const data = JSON.parse(json);
                        dadosNF = data;
                        atualiza();
            
                    })            
                }
            
                function atualiza(){
            
                    function run(id,index){
                        const frm = document.getElementById(id);
                        for(let i=0; i<frm.length; i++){
                            if(frm[i].id in dadosNF.NF[index]){
                                frm[i].value = dadosNF.NF[index][frm[i].id].toString().trim() ;
                            }
                        }
                    }
                    run("C",3);
                    run("C02",4);
                    run("C05",5);
                    run("B",2);
                    run("E",6);
                    run("E02",7);
                    run("E05",8);                   
                    
                    //atualiza as datas para a data atual
                    const date = today.getFullYear()+"-"+today.getMonth().toString().padStart(2, '0')+"-"+today.getDate();
                    document.getElementById('dhEmi').value = date
                    document.getElementById('dhSaiEnt').value = date


                }
            
                function salvaNF(id,index){
                    const frm = document.getElementById(id);

                    for(let i=0; i<frm.length; i++){
                        dadosNF.NF[index][frm[i].id] = frm[i].value.trim();
                    }
            
                    const json = JSON.stringify(dadosNF);
            
                    const data = new URLSearchParams();        
                        data.append("path", "../config/nfe.json");
                        data.append("json", json);
            
                    const resp = getData("ajax/ajax_saveJson.php", data);
            
            //        console.log(json)
            
                }
            
                function geraNFE(){
                    hora = today.getHours().toString().padStart(2, '0');
                    min = today.getMinutes().toString().padStart(2, '0');
                    seg = today.getSeconds().toString().padStart(2, '0');
                    dadosNF.NF[1].id = geraChave()
            
                    let txt = '';
                //            console.log(dadosNF.NF)
                    for(let i=0; i<dadosNF.NF.length; i++){
                        const row = Object.entries(dadosNF.NF[i])
                        for(let j=0; j<row.length; j++){
                            if(row[j][0] == 'dhEmi' || row[j][0] == 'dhSaiEnt'){ // coloca hora na data
                                row[j][1]+='T'+hora+':'+min+':'+seg+'-03:00';
                                hora++;
                                if(hora == 24){
                                    hora = 0;
                                }
                                hora = hora.toString().padStart(2, '0');
                            }                
                            txt += row[j][1]+'|';                
                        }
                        txt += '\r\n';            
                    }
                    for(let i=0; i<dadosNF.itens.length; i++){
                        for(let g=0; g<dadosNF.itens[i].length; g++){
                            const row = Object.entries(dadosNF.itens[i][g])
                            for(let j=0; j<row.length; j++){              
                                txt += row[j][1]+'|';                
                            }
                            txt += '\r\n';  
                        }                        
                    }
                    const parcelas = document.getElementById('edtDiasParcelas').value.split('/');
                    const total = parseFloat(document.getElementById('edtValorNF').value).toFixed(2);
                    let ultimaparc = parseFloat(total);
                    let desconto = 0;
//                    console.log(parcelas);                    
//                    console.log(dadosNF.fatura);
//                    console.log(ultimaparc)

                    for(let i=0; i<dadosNF.fatura.length; i++){
                        const row = Object.entries(dadosNF.fatura[i])
                        if(i==4){
                            txt += `Y02|${parcelas.length}|${total}|${desconto.toFixed(2)}|${(total - desconto).toFixed(2)}|\r\n`;
                        }else if(i==5){ // parcelas pgto
                            let valorParc =  (total/parcelas.length).toFixed(2);
                            for(let q=0; q<parcelas.length; q++){
                                if(q == parcelas.length-1){
                                    valorParc = (ultimaparc).toFixed(2);
                                }else{
                                    ultimaparc -= valorParc;
                                }
//                                console.log(dadosNF.NF[2].dhEmi)
                                dia = new Date(dadosNF.NF[2].dhEmi);
                                dia.setDate(dia.getDate() + parseInt(parcelas[q]) + 1);
//                                console.log(dia.getMonth())
                                const datasVenc = dia.getFullYear()+'-'+(dia.getMonth()+1).toString().padStart(2, '0')+'-'+dia.getDate().toString().padStart(2, '0') ;
                                txt += `Y07|${(q+1).toString().padStart(3, '0')}|${datasVenc}|${valorParc}|\r\n`;                            
                            }
                        }else if(i==6){                            
//                            txt += `W04c|${(0).toFixed(2)}|\r\n`;                            
//                            txt += `W04e|${(0).toFixed(2)}|\r\n`;                            
//                            txt += `W04g|${(0).toFixed(2)}|\r\n`;                            
//                            txt += `X|${0}|\r\n`;                            
//                            txt += `X03|FLEXIBUS SANFONADOS LTDA|234033845113|AV. DR. ROSALVO DE ALMEIDA TELLES,2070- NOVA CACAPAVA|Cacapava|SP|\r\n`;                            
//                            txt += `X04|00519547000106|\r\n`;                            
                            txt += `YA\r\n`;                            
                            txt += `YA01|1|15|${total}|\r\n`;                            

                        }else if(i==7){

                            // tira qualquer quebra de linha do texto complementar
                            const compl = document.getElementById('txaTextoCompl').value.trim().split('\n');
                            let outTxt = "";
                            for(let j=0; j<compl.length; j++){
                                outTxt += compl[j]+" ";
                            }
                            
                            console.log(outTxt)
                            txt += `Z||${outTxt}|\r\n`;                            

                        }else{
                            for(let j=0; j<row.length; j++){
                                txt += row[j][1]+'|';                
                            }
                            txt += '\r\n';            
                            
                        }
                    }            
//                    console.log(txt)

                    // Save File TXT
                    const sFileName = `NFe${dadosNF.NF[2].nNF.padStart(6, '0')}.txt`;	   // The file to save the data.

                    let data = new URLSearchParams();        
                        data.append("path", `../NF_txt/${sFileName}`);
                        data.append("json", txt);
            
                    const resp = getData("ajax/ajax_saveJson.php", data);
                    alert(` NF ${dadosNF.NF[2].nNF} exportada com sucesso`)

                    resp.then(()=>{
                        document.querySelector('.tab-export').click();

                    })




                    // proxima NF (soma 1);
                    dadosNF.NF[2].nNF = parseInt(dadosNF.NF[2].nNF)+1;
                    atualiza();
                    salvaNF("B",2)

                }                
            
                function getData(url,data){
                    const myRequest = new Request(url,{
                        method : "POST",
                        body : data
                    });                
            
                    return new Promise((resolve,reject) =>{
            
                        fetch(myRequest)
                        .then(function (response){
            
                            if (response.status === 200) { 
                                resolve(response.text());
                            } else { 
                                reject(new Error("Houve algum erro na comunicação com o servidor"));
                            } 
                        })                    
                    });            
                }
            
                function IBGE_cMun(){
                    dadosNF.NF[8].cMun = '';
                    const UF_cod = new Promise((resolve,reject) =>{
            
                        fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados")
                        .then(function (response){
            
                            if (response.status === 200) { 
                                resolve(response.text());
                            } else { 
                                reject(new Error("Houve algum erro na comunicação com o servidor"));
                            } 
                        })                    
                    });   
                    
                    UF_cod.then((resolve)=>{
                        const json = JSON.parse(resolve);
            
                        for(let i=0; i<json.length; i++){
                            if(json[i].sigla == dadosNF.NF[8].UF){
            
                                const Mun_cod = new Promise((resolve,reject) =>{
            
                                    fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${json[i].id}/municipios`)
                                    .then(function (response){
            
                                        if (response.status === 200) { 
                                            resolve(response.text());
                                        } else { 
                                            reject(new Error("Houve algum erro na comunicação com o servidor"));
                                        } 
                                    })                    
                                }); 
            
                                Mun_cod.then((resolve)=>{
                                    const json = JSON.parse(resolve);
                                    for(let j=0; j<json.length; j++){
                                        if(json[j].nome.trim().toLowerCase() == dadosNF.NF[8].xMun.trim().toLowerCase()){
                                            dadosNF.NF[8].cMun = json[j].id;
                                            atualiza()
            //                                salvaNF("E05",8);                                   
                                            break;
                                        }
                                    }
            
                                })
                            
                            }
                        }
                        
                    })
            
                }
            
                function geraChave(){
            
                    mes = today.getMonth().toString().padStart(2, '0');
                    ano = today.getFullYear().toString().substr(2,2);
                    const aamm = ano+mes;
            
            //        geraChave(dadosNF.NF[4].CNPJ,dadosNF.NF[2].nNF,ano+mes)
                    const CNPJ = dadosNF.NF[4].CNPJ;
                    const nNF = dadosNF.NF[2].nNF.padStart(9, '0');
                    const uf = "35";            // cUF - Código da UF do emitente do Documento Fiscal;
                //            const aamm = ano+mes;        // AAMM - Ano e Mês de emissão da NF-e;
                    const tpEmis = "1";         // tpEmis – forma de emissão da NF-e;
                    const cod = dadosNF.NF[2].cNF  // cNF - Código Numérico que compõe a Chave de Acesso; (random entre 10000000 e 99999999)
                    const mod = "55";           // mod - Modelo do Documento Fiscal;
                    const ser = "001";          // serie - Série do Documento Fiscal;
            //        Nnf = Nnf.padStart(9, '0') ;    // nNF - Número do Documento Fiscal;
            
                    const chave = uf + aamm + CNPJ + mod + ser +  nNF + tpEmis + cod ;
            
                    let dv = 0;
                    let mult = 2;
                        for(let i = 1; i < chave.length+1; i++){
                            dv = dv + (chave[chave.length - i] * mult);
                            mult++;
            
                            if (mult > 9){
                            mult = 2;
                            }
                        }
            
                        let resto = dv % 11;
                        dv = 11 - resto;
            
                        if(dv > 9){
                            dv = 0;
                        }
            
                        return 'NFe'+chave+dv;
            
                }
*/

</script>