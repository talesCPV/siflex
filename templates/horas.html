
<template>
    <style>
        th{
            text-align: center;
        }
        
        #tblHoras tr{
            font-size: 0.8em; 
            line-height: 10px;           
        }

        .weekend{
            background-color: #FAE7E8 !important;
        }

        .workday{
            background-color: #ffffff !important;
        }

        .workHE{
            background-color: #acc1f1 !important;
        }

        .nowork{
            background-color: #db6666 !important;
        }


    </style>

    <div class="form-base">
        <h1>Relógio de Ponto</h1>
        <fieldset>
            <legend>Busca por data</legend>
    
            <div class="inline">
                <select id="cmbBusca">
                    <option value="true" signal="=" val="true" field_2="1" val_2="1">Todos</option>                        
                    <option value="FUNC.nome" signal="LIKE" field_2="1" val_2="1" >Funcionário</option>
                    <option value="CAR.tipo" signal="=" val="HORA" field_2="FUNC.status" val_2="ATIVO" selected>Horista</option>
                    <option value="CAR.tipo" signal="=" val="MENSAL" field_2="FUNC.status" val_2="ATIVO" >Mensalista</option>
                    <option value="FUNC.status" signal="=" val="ATIVOS" field_2="1" val_2="1">Ativos</option>                    
                    <option value="FUNC.status" signal="=" val="DEMIT" field_2="1" val_2="1">Inativos</option>                    
                </select>
                <input type="text" id="edtBusca" placeholder="Digite sua busca">
                <button id="btnBusca">Busca</button>
            </div>
            <div class="inline center-itens">
                <input type="date" id="edtIni">
                <input type="date" id="edtFin">
            </div>
    
        </fieldset>
        <table id="tblHoras"></table>
    </div>

    

</template>
<script>

    main_data.horas.data = new Object

    const hj = today.getDate()
    while(today.getDate()!=26){
        today.change(-1)
    }
    document.querySelector('#edtIni').value =  today.getFormatDate()
    while(today.getDate()!=25){
        today.change(1)
    }
    document.querySelector('#edtFin').value =  today.getFormatDate()    
    while(today.getDate()!=hj){
        today.change(-1)
    }

    function somaHora(ent,sai){        
        let H = 0
        let M = 0
        let ini_H = parseInt(ent.substring(0,2))
        let ini_M = parseInt(ent.substring(3,5))
        let fin_H = parseInt(sai.substring(0,2))
        let fin_M = parseInt(sai.substring(3,5))

        while(ini_H != fin_H){
            H++
            ini_H++
            ini_H = ini_H>=24 ? 0 : ini_H
        }

        while(ini_M != fin_M){
            ini_M++
            M++
            ini_M = ini_M>=60 ? 0 : ini_M
        }
//        console.log([ini_H, fin_H, H])
//        console.log([ini_M, fin_M, M])
//        console.log(`${H}.${M/60}`)
        return parseFloat(H)+parseFloat(M/60)

    }


    function grid(){
        const func = main_data.horas.data.func
        const he = main_data.horas.data.he
        const date_ini = new Date(document.querySelector('#edtIni').value)
        date_ini.change(1)
        const date_fin = new Date(document.querySelector('#edtFin').value)
        date_fin.change(1)
        const date = date_ini
        let he_pointer = 0

        function fillBlank(D){
            if([0,6].includes(D)){
                return '<td>00:00</td><td>00:00</td>'
            }else{
                return '<td>07:00</td><td>17:00</td>'
            }
        }
// cabeçalho
        funcionarios = []
        const tbl = ['<tr><th colspan="2"></th>','<tr><th colspan="2">DATA</th>'] 
        for(let i=0; i<func.length; i++){
            tbl[0] += `<th colspan="2">${func[i].nome.split(' ')[0]}</th>`
            tbl[1] += '<th>Ent.</th><th>Sai.</th>'
            const f = new Object
                f.id = func[i].id
                f.nome = func[i].nome.split(' ')[0]
                f.horas = 0
                f.he = 0
                f.ad_nt = 0
            funcionarios.push(f)
        }
// dias funcionarios
        while(date <= date_fin){ 
            let tr = [0,6].includes(date.getDay()) ? '<tr class="weekend">' : '<tr class="workday">'
                tr += `${tr}<th>${date.getFormatBR()}</th><th>${semana[date.getDay()]}</th>`
            for(let i=0; i<func.length; i++){
                if(he.length > 0 && he_pointer < he.length){
                    const next = new Date(he[he_pointer].entrada)
                    if(date.getFormatDate() == next.getFormatDate() && he[he_pointer].id_func == func[i].id ){
                        console.log(func[i].nome + ' - ' + next.getFormatBR())
                        const ent = he[he_pointer].entrada.substring(11,16)
                        const sai = he[he_pointer].saida.substring(11,16)
                        console.log(somaHora(ent,sai))
                        tr += `<td class="workHE">${ent}</td>`
                        tr += `<td class="workHE">${sai}</td>`
                        he_pointer++
                    }else{
                        tr += fillBlank(date.getDay())
                    }
                }else{
                    tr += fillBlank(date.getDay())
                }  
            }
            tbl.push(tr)            
            date.change(1)            
        }

        document.querySelector('#tblHoras').innerHTML =''
        for(let i=0; i<tbl.length; i++){
            document.querySelector('#tblHoras').innerHTML += tbl[i]+'</tr>'
        }         
    }



    document.querySelector('#btnBusca').addEventListener('click',()=>{
        const sel = document.querySelector('#cmbBusca')
        const field = sel.value
        const signal = sel.options[sel.selectedIndex].getAttribute('signal')
        let value = sel.options[sel.selectedIndex].hasAttribute('val') ? sel.options[sel.selectedIndex].getAttribute('val') : document.querySelector('#edtBusca').value.trim()
        value = signal=='LIKE' ? `"%${value}%"` : sel.value=='true'? sel.value : `"${value}"`
        const field_2 = sel.options[sel.selectedIndex].getAttribute('field_2')
        const val_2 = sel.options[sel.selectedIndex].getAttribute('val_2')

        const params = new Object;
            params.field = field
            params.signal = signal
            params.value = value
            params.hash = localStorage.getItem('hash')
            params.field_2 = field_2
            params.value_2 = val_2
            params.ini = document.querySelector('#edtIni').value
            params.fin = document.querySelector('#edtFin').value   

        const myPromisse = queryDB(params,56);

        myPromisse.then((resolve)=>{
            if(resolve.trim() != ""){
                main_data.horas.data.func = JSON.parse(resolve);
                const myPromisse_2 = queryDB(params,59)
                myPromisse_2.then((resolve_2)=>{
                    main_data.horas.data.he = JSON.parse(resolve_2)
                    grid()
                })                
            }        
        })

    })

    document.querySelector('#tblHoras').addEventListener('click',(e)=>{
        data = e.target.parentNode.data
        data.mode = 'edit'
        openHTML('viewHora.html','pop-up','Relógio de Ponto',data)
    })




</script>